{"version":3,"file":"prolease-ifrs16-plugin.iife.js","sources":["../src/plugins/prolease-ifrs16-plugin.ts","../src/plugins/index.ts"],"sourcesContent":["/**\n * ProLease IFRS 16 Plugin for DataForge v6\n *\n * Native TypeScript implementation following DataForge v6 plugin architecture\n * Provides complete IFRS 16 lease accounting calculations with amortization schedules\n *\n * @author DJCalc / C√≥digo\n * @version 6.0.0\n * @date 2025-10-23\n */\n\nimport type { PluginContext, PluginManifest } from '../@core/types';\nimport type { Plugin } from '../@core/plugin-system-consolidated';\nimport type { Sheet } from '../@core/workbook-consolidated';\nimport { logger } from '../@core/storage-utils-consolidated';\n\n// ============================================================================\n// TYPES & INTERFACES\n// ============================================================================\n\ninterface LeaseContract {\n  id: string;\n  contractName: string;\n  termMonths: number;\n  startDate: string; // YYYY-MM-DD\n  totalRent: number;\n  serviceDeductions: number;\n  discountRate: number; // Annual percentage\n  initialLandlordAllowance: number;\n  initialDirectCosts: number;\n  createdAt: string;\n  updatedAt: string;\n}\n\n// ============================================================================\n// PLUGIN CLASS\n// ============================================================================\n\nexport class ProLeasePlugin implements Plugin {\n  manifest: PluginManifest = {\n    id: 'dj.ifrs16.prolease',\n    name: 'ProLease IFRS 16',\n    version: '6.0.0',\n    author: 'DJCalc / C√≥digo',\n    description: 'IFRS 16 lease accounting calculator with comprehensive amortization schedules',\n    permissions: [\n      'read:workbook',\n      'write:workbook',\n      'ui:toolbar',\n      'ui:panel',\n      'formula:register',\n      'read:storage',\n      'write:storage',\n    ],\n    entryPoint: 'prolease-ifrs16-plugin.ts',\n  };\n\n  private context!: PluginContext;\n  private contracts: LeaseContract[] = [];\n  private worker?: Worker;\n\n  // ========================================================================\n  // LIFECYCLE METHODS\n  // ========================================================================\n\n  async init(context: PluginContext): Promise<void> {\n    this.context = context;\n    logger.info('[ProLeasePlugin] Initializing v6.0.0...');\n\n    try {\n      // Load saved contracts from persistent storage\n      await this.loadContracts();\n\n      // Create Web Worker for background calculations\n      this.worker = this.createCalculationWorker();\n\n      // Register IFRS 16 formulas for spreadsheet use\n      this.registerFormulas();\n\n      // Setup UI elements\n      this.setupUI();\n\n      logger.info(`[ProLeasePlugin] Ready with ${this.contracts.length} saved contracts`);\n      context.ui.showToast(`ProLease IFRS 16 loaded! ${this.contracts.length} contract(s)`, 'success');\n    } catch (error) {\n      logger.error('[ProLeasePlugin] Initialization failed', error);\n      context.ui.showToast('Failed to load ProLease plugin', 'error');\n      throw error;\n    }\n  }\n\n  async dispose(): Promise<void> {\n    logger.info('[ProLeasePlugin] Disposing...');\n\n    // Terminate worker\n    if (this.worker) {\n      this.worker.terminate();\n      this.worker = undefined;\n    }\n\n    // Save any pending data\n    await this.saveContracts();\n\n    logger.info('[ProLeasePlugin] Disposed successfully');\n  }\n\n  // ========================================================================\n  // DATA PERSISTENCE\n  // ========================================================================\n\n  private async loadContracts(): Promise<void> {\n    try {\n      const saved = await this.context.storage.get('contracts');\n      this.contracts = saved || [];\n      logger.info(`[ProLeasePlugin] Loaded ${this.contracts.length} contracts`);\n    } catch (error) {\n      logger.error('[ProLeasePlugin] Failed to load contracts', error);\n      this.contracts = [];\n    }\n  }\n\n  private async saveContracts(): Promise<void> {\n    try {\n      await this.context.storage.set('contracts', this.contracts);\n      logger.info(`[ProLeasePlugin] Saved ${this.contracts.length} contracts`);\n    } catch (error) {\n      logger.error('[ProLeasePlugin] Failed to save contracts', error);\n      throw error;\n    }\n  }\n\n  // ========================================================================\n  // FORMULA REGISTRATION\n  // ========================================================================\n\n  private registerFormulas(): void {\n    const registry = this.context.kernel.calcEngine.getRegistry();\n\n    // Present Value for Lease Payments\n    registry.register(\n      'LEASE_PV',\n      (monthlyRate: number, months: number, payment: number) => {\n        if (monthlyRate === 0) return payment * months;\n        return payment * ((1 - Math.pow(1 + monthlyRate, -months)) / monthlyRate);\n      },\n      {\n        argCount: 3,\n        description: 'Calculate present value for lease payments (rate, months, payment)',\n      }\n    );\n\n    // Convert Annual Rate to Monthly Rate\n    registry.register(\n      'LEASE_MONTHLY_RATE',\n      (annualRate: number) => {\n        return Math.pow(1 + annualRate / 100, 1 / 12) - 1;\n      },\n      {\n        argCount: 1,\n        description: 'Convert annual discount rate to monthly rate (annual %)',\n      }\n    );\n\n    // Calculate ROU Asset Opening Balance\n    registry.register(\n      'LEASE_ROU_OPENING',\n      (leaseLiability: number, directCosts: number, allowance: number) => {\n        return leaseLiability + directCosts - allowance;\n      },\n      {\n        argCount: 3,\n        description: 'Calculate opening ROU asset (liability, direct costs, allowance)',\n      }\n    );\n\n    logger.info('[ProLeasePlugin] Registered 3 IFRS 16 formulas');\n  }\n\n  // ========================================================================\n  // UI SETUP\n  // ========================================================================\n\n  private setupUI(): void {\n    // Add toolbar button\n    this.context.ui.addToolbarButton({\n      id: 'prolease-new-contract',\n      label: 'New Lease',\n      icon: 'üìã',\n      tooltip: 'Create new IFRS 16 lease contract',\n      onClick: () => this.handleNewContract(),\n    });\n\n    // Add control panel\n    this.context.ui.addPanel({\n      id: 'prolease-manager',\n      title: 'üìã ProLease Manager',\n      position: 'right',\n      render: (container) => this.renderControlPanel(container),\n    });\n\n    logger.info('[ProLeasePlugin] UI elements registered');\n  }\n\n  private renderControlPanel(container: HTMLElement): void {\n    container.innerHTML = `\n      <div class=\"prolease-panel\" style=\"padding: 8px;\">\n        <button id=\"prolease-create-btn\" class=\"prolease-btn-primary\" style=\"\n          width: 100%;\n          padding: 10px;\n          margin-bottom: 12px;\n          background: #3b82f6;\n          color: white;\n          border: none;\n          border-radius: 6px;\n          cursor: pointer;\n          font-weight: 500;\n        \">\n          ‚ûï Create New Contract\n        </button>\n\n        <div style=\"margin-bottom: 8px; font-size: 12px; color: #64748b; font-weight: 500;\">\n          SAVED CONTRACTS (${this.contracts.length})\n        </div>\n\n        <div id=\"prolease-contracts-list\" style=\"\n          max-height: 400px;\n          overflow-y: auto;\n          border: 1px solid #e2e8f0;\n          border-radius: 6px;\n        \">\n          ${this.renderContractsList()}\n        </div>\n      </div>\n    `;\n\n    // Attach event listeners\n    const createBtn = container.querySelector('#prolease-create-btn');\n    createBtn?.addEventListener('click', () => this.handleNewContract());\n\n    this.attachContractListeners(container);\n  }\n\n  private renderContractsList(): string {\n    if (this.contracts.length === 0) {\n      return `\n        <div style=\"padding: 20px; text-align: center; color: #94a3b8; font-size: 13px;\">\n          No contracts yet.<br>Click \"Create New Contract\" to begin.\n        </div>\n      `;\n    }\n\n    return this.contracts\n      .map(\n        (c) => `\n        <div class=\"contract-item\" style=\"\n          padding: 12px;\n          border-bottom: 1px solid #e2e8f0;\n          transition: background 0.2s;\n        \">\n          <div style=\"font-weight: 600; font-size: 14px; color: #1e293b; margin-bottom: 4px;\">\n            ${this.escapeHtml(c.contractName)}\n          </div>\n          <div style=\"font-size: 12px; color: #64748b; margin-bottom: 8px;\">\n            üìÖ ${new Date(c.startDate).toLocaleDateString()} |\n            üìä ${c.termMonths} months |\n            üí∞ ${this.formatCurrency(c.totalRent)}/mo\n          </div>\n          <div style=\"display: flex; gap: 6px;\">\n            <button\n              data-contract-id=\"${c.id}\"\n              data-action=\"recalc\"\n              style=\"\n                flex: 1;\n                padding: 6px 12px;\n                font-size: 12px;\n                background: #10b981;\n                color: white;\n                border: none;\n                border-radius: 4px;\n                cursor: pointer;\n                font-weight: 500;\n              \">\n              üîÑ Recalculate\n            </button>\n            <button\n              data-contract-id=\"${c.id}\"\n              data-action=\"delete\"\n              style=\"\n                padding: 6px 12px;\n                font-size: 12px;\n                background: #ef4444;\n                color: white;\n                border: none;\n                border-radius: 4px;\n                cursor: pointer;\n                font-weight: 500;\n              \">\n              üóëÔ∏è\n            </button>\n          </div>\n        </div>\n      `\n      )\n      .join('');\n  }\n\n  private attachContractListeners(container: HTMLElement): void {\n    // Recalculate buttons\n    container.querySelectorAll('[data-action=\"recalc\"]').forEach((btn) => {\n      btn.addEventListener('click', (e) => {\n        const contractId = (e.target as HTMLElement).getAttribute('data-contract-id');\n        const contract = this.contracts.find((c) => c.id === contractId);\n        if (contract) {\n          this.handleRecalculate(contract);\n        }\n      });\n    });\n\n    // Delete buttons\n    container.querySelectorAll('[data-action=\"delete\"]').forEach((btn) => {\n      btn.addEventListener('click', (e) => {\n        const contractId = (e.target as HTMLElement).getAttribute('data-contract-id');\n        this.handleDelete(contractId);\n      });\n    });\n\n    // Hover effects\n    container.querySelectorAll('.contract-item').forEach((item) => {\n      item.addEventListener('mouseenter', () => {\n        (item as HTMLElement).style.background = '#f8fafc';\n      });\n      item.addEventListener('mouseleave', () => {\n        (item as HTMLElement).style.background = 'transparent';\n      });\n    });\n  }\n\n  // ========================================================================\n  // USER ACTIONS\n  // ========================================================================\n\n  private handleNewContract(): void {\n    logger.info('[ProLeasePlugin] Creating new contract');\n\n    const contractName = prompt('Contract Name:', `Contract ${this.contracts.length + 1}`);\n    if (!contractName) {\n      this.context.ui.showToast('Contract creation cancelled', 'info');\n      return;\n    }\n\n    if (this.contracts.some((c) => c.contractName === contractName)) {\n      this.context.ui.showToast('Contract name already exists', 'error');\n      return;\n    }\n\n    const termMonths = this.promptNumber('Term (months):', 36);\n    if (termMonths === null || termMonths <= 0) return;\n\n    const startDate = prompt(\n      'Start Date (YYYY-MM-DD):',\n      new Date().toISOString().split('T')[0]\n    );\n    if (!startDate) return;\n\n    const totalRent = this.promptNumber('Monthly Rent (gross):', 80000);\n    if (totalRent === null || totalRent <= 0) return;\n\n    const serviceDeductions = this.promptNumber('Monthly Service Deductions:', 5000);\n    if (serviceDeductions === null) return;\n\n    const discountRate = this.promptNumber('Annual Discount Rate (%):', 15);\n    if (discountRate === null) return;\n\n    const initialLandlordAllowance = this.promptNumber('Landlord Allowance:', 0);\n    if (initialLandlordAllowance === null) return;\n\n    const initialDirectCosts = this.promptNumber('Initial Direct Costs:', 30000);\n    if (initialDirectCosts === null) return;\n\n    const contract: LeaseContract = {\n      id: this.generateId(),\n      contractName,\n      termMonths,\n      startDate,\n      totalRent,\n      serviceDeductions,\n      discountRate,\n      initialLandlordAllowance,\n      initialDirectCosts,\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString(),\n    };\n\n    this.contracts.push(contract);\n    this.saveContracts();\n\n    logger.info('[ProLeasePlugin] Contract created', { id: contract.id, name: contractName });\n    this.context.ui.showToast(`Contract \"${contractName}\" created. Calculating...`, 'info');\n\n    this.calculateAndCreateSheet(contract);\n    this.refreshControlPanel();\n  }\n\n  private handleRecalculate(contract: LeaseContract): void {\n    logger.info('[ProLeasePlugin] Recalculating contract', { id: contract.id });\n    this.context.ui.showToast(`Recalculating \"${contract.contractName}\"...`, 'info');\n    this.calculateAndCreateSheet(contract);\n  }\n\n  private async handleDelete(contractId: string | null): Promise<void> {\n    if (!contractId) return;\n\n    const contract = this.contracts.find((c) => c.id === contractId);\n    if (!contract) return;\n\n    if (!confirm(`Delete contract \"${contract.contractName}\"?\\n\\nThis action cannot be undone.`)) {\n      return;\n    }\n\n    this.contracts = this.contracts.filter((c) => c.id !== contractId);\n    await this.saveContracts();\n\n    logger.info('[ProLeasePlugin] Contract deleted', { id: contractId });\n    this.context.ui.showToast('Contract deleted', 'success');\n\n    this.refreshControlPanel();\n  }\n\n  // ========================================================================\n  // CALCULATION ENGINE\n  // ========================================================================\n\n  private calculateAndCreateSheet(contract: LeaseContract): void {\n    if (!this.worker) {\n      this.context.ui.showToast('Calculator not ready', 'error');\n      return;\n    }\n\n    this.worker.postMessage({ action: 'calculate', payload: contract });\n\n    this.worker.onmessage = (event) => {\n      const { action, payload, error } = event.data || {};\n\n      if (error) {\n        logger.error('[ProLeasePlugin] Calculation error:', error);\n        this.context.ui.showToast(`Calculation error: ${error}`, 'error');\n        return;\n      }\n\n      if (action === 'calculationComplete') {\n        this.populateSheet(contract, payload.calculatedRows);\n      }\n    };\n  }\n\n  private populateSheet(contract: LeaseContract, calculatedRows: any[][]): void {\n    try {\n      const wbManager = this.context.kernel.workbookManager;\n\n      // Get or create workbook\n      let wb = wbManager.getActiveWorkbook();\n      if (!wb) {\n        wb = wbManager.createWorkbook('ProLease IFRS 16 Calculations');\n        wbManager.setActiveWorkbook(wb.id);\n        logger.info('[ProLeasePlugin] Created new workbook');\n      }\n\n      // Create or get sheet\n      const sheetName = `IFRS16 - ${contract.contractName}`;\n      const sheets = Array.from(wb.sheets.values()) as Sheet[];\n      let sheet: Sheet | undefined = sheets.find((s: Sheet) => s.name === sheetName);\n\n      if (!sheet) {\n        sheet = wb.addSheet(sheetName);\n        logger.info('[ProLeasePlugin] Created new sheet', { name: sheetName });\n      } else {\n        // Clear existing data\n        const rows = sheet.rows;\n        rows.forEach((rowMap: Map<number, any>, rowIdx: number) => {\n          rowMap.forEach((_cell: any, colIdx: number) => {\n            sheet!.clearCell(rowIdx, colIdx);\n          });\n        });\n        logger.info('[ProLeasePlugin] Cleared existing sheet', { name: sheetName });\n      }\n\n      if (!sheet) {\n        throw new Error('Failed to create or get sheet');\n      }\n\n      // Populate with headers and data\n      const headers = calculatedRows[0] || [];\n      const dataRows = calculatedRows.slice(1) || [];\n\n      // Set headers\n      headers.forEach((header: any, col: number) => {\n        sheet!.setCell(0, col, String(header), {\n          type: 'string',\n          format: { bold: true, alignment: 'center' },\n        });\n      });\n\n      // Set data rows\n      dataRows.forEach((row: any[], rowIdx: number) => {\n        row.forEach((val: any, col: number) => {\n          const cellType = typeof val === 'number' ? 'number' : col === 1 ? 'date' : 'string';\n          sheet!.setCell(rowIdx + 1, col, val, { type: cellType });\n        });\n      });\n\n      // Activate the sheet\n      wb.setActiveSheet(sheet.id);\n\n      // Trigger recalculation\n      this.context.kernel.kernel.recalculate(sheet.id, undefined, { force: true });\n\n      logger.info('[ProLeasePlugin] Sheet populated successfully', {\n        contract: contract.contractName,\n        rows: dataRows.length,\n        cols: headers.length,\n      });\n\n      this.context.ui.showToast(`Sheet \"${sheetName}\" created with ${dataRows.length} rows!`, 'success');\n    } catch (error) {\n      logger.error('[ProLeasePlugin] Sheet population failed', error);\n      this.context.ui.showToast('Failed to create sheet', 'error');\n    }\n  }\n\n  // ========================================================================\n  // WEB WORKER CREATION\n  // ========================================================================\n\n  private createCalculationWorker(): Worker {\n    const code = `\n      // IFRS 16 Calculation Worker\n      self.onmessage = function(event) {\n        const { action, payload } = event.data || {};\n        if (action !== 'calculate') return;\n\n        try {\n          const rows = generate(payload);\n          const headers = getHeaders();\n          self.postMessage({\n            action: 'calculationComplete',\n            payload: { contractData: payload, calculatedRows: [headers, ...rows] }\n          });\n        } catch (error) {\n          self.postMessage({ error: (error && error.message) || String(error) });\n        }\n      };\n\n      function getHeaders() {\n        return [\n          \"Month #\",\n          \"Date\",\n          \"A) Sum of All Costs\",\n          \"B) Monthly Service Deductions\",\n          \"C) Landlord TI Allowance after Commence Date\",\n          \"D) Total Rent to be Capitalized (A + B + C)\",\n          \"Remaining Present Value\",\n          \"E) Interest\",\n          \"End of Month Lease Liability\",\n          \"Current Short Term (ST) Liability\",\n          \"Non Current Long Term (LT) Liability\",\n          \"Proof Column (ST+LT)\",\n          \"F) New Initial Landlord Allowance\",\n          \"I) Allowance Amortization\",\n          \"J) Allowance Closing Balance\",\n          \"K) New IDC\",\n          \"N) IDC Amortization\",\n          \"O) IDC Closing Balance\",\n          \"S) Opening ROU Asset\",\n          \"U) ROU Asset Amortization\",\n          \"V) ROU Asset Closing Balance\",\n          \"Total ROU Asset Closing Balance (J+O+V)\",\n          \"W) Total P&L Non-Financial Expense\",\n          \"P&L - Reported Lease Expense (E+W)\"\n        ];\n      }\n\n      function generate(d) {\n        const rows = [];\n        const termMonths = Number(d.termMonths || 0);\n        const totalRent = Number(d.totalRent || 0);\n        const serviceDeductions = Number(d.serviceDeductions || 0);\n        const discountRate = Number(d.discountRate || 0);\n        const initialLandlordAllowance = Number(d.initialLandlordAllowance || 0);\n        const initialDirectCosts = Number(d.initialDirectCosts || 0);\n        const startDate = new Date(d.startDate);\n\n        const monthlyDiscountRate = Math.pow(1 + (discountRate / 100), 1/12) - 1;\n        const rentToCapitalize = totalRent - serviceDeductions;\n\n        // Calculate initial lease liability (present value of all payments)\n        let initialLeaseLiability = 0;\n        for (let i = 0; i < termMonths; i++) {\n          initialLeaseLiability += rentToCapitalize / Math.pow(1 + monthlyDiscountRate, i + 1);\n        }\n\n        // Opening ROU asset\n        const openingROU = initialLeaseLiability + initialDirectCosts - initialLandlordAllowance;\n\n        // Monthly amortization amounts\n        const allowanceAmort = termMonths > 0 ? initialLandlordAllowance / termMonths : 0;\n        const idcAmort = termMonths > 0 ? initialDirectCosts / termMonths : 0;\n        const rouAmort = termMonths > 0 ? openingROU / termMonths : 0;\n\n        // Running balances\n        let curLease = initialLeaseLiability;\n        let curAllowance = initialLandlordAllowance;\n        let curIDC = initialDirectCosts;\n        let curROU = openingROU;\n\n        // Generate monthly rows\n        for (let i = 1; i <= termMonths; i++) {\n          const row = [];\n          const curDate = new Date(startDate);\n          curDate.setMonth(curDate.getMonth() + (i - 1));\n\n          // Interest and principal\n          const interest = curLease * monthlyDiscountRate;\n          const principal = rentToCapitalize - interest;\n\n          // Month number and date\n          row[0] = i;\n          row[1] = curDate.toISOString().split('T')[0];\n\n          // Costs\n          row[2] = totalRent;\n          row[3] = serviceDeductions;\n          row[4] = 0; // TI Allowance after commence (typically 0)\n          row[5] = rentToCapitalize;\n\n          // Remaining PV\n          let remainingPV = 0;\n          for (let j = i; j < termMonths; j++) {\n            remainingPV += rentToCapitalize / Math.pow(1 + monthlyDiscountRate, j - i + 1);\n          }\n          row[6] = remainingPV;\n\n          // Interest and liability\n          row[7] = interest;\n          curLease -= principal;\n          row[8] = Math.abs(curLease) < 0.01 ? 0 : curLease;\n\n          // ST/LT classification\n          let st = 0, lt = 0, tmp = curLease;\n          for (let m = 0; m < (termMonths - i); m++) {\n            const fInt = tmp * monthlyDiscountRate;\n            const fPr = rentToCapitalize - fInt;\n            if (m < 12) st += fPr;\n            else lt += fPr;\n            tmp -= fPr;\n          }\n          row[9] = st;\n          row[10] = lt;\n          row[11] = st + lt;\n\n          // Landlord allowance\n          row[12] = (i === 1) ? initialLandlordAllowance : 0;\n          row[13] = allowanceAmort;\n          curAllowance -= allowanceAmort;\n          row[14] = Math.abs(curAllowance) < 0.01 ? 0 : curAllowance;\n\n          // Initial direct costs\n          row[15] = (i === 1) ? initialDirectCosts : 0;\n          row[16] = idcAmort;\n          curIDC -= idcAmort;\n          row[17] = Math.abs(curIDC) < 0.01 ? 0 : curIDC;\n\n          // ROU asset\n          row[18] = curROU;\n          row[19] = rouAmort;\n          curROU -= rouAmort;\n          row[20] = Math.abs(curROU) < 0.01 ? 0 : curROU;\n\n          // Total ROU and P&L\n          row[21] = curROU + curIDC + curAllowance;\n          row[22] = rouAmort + idcAmort - allowanceAmort;\n          row[23] = interest + row[22];\n\n          rows.push(row);\n        }\n\n        return rows;\n      }\n    `;\n\n    const blob = new Blob([code], { type: 'application/javascript' });\n    const url = URL.createObjectURL(blob);\n    const worker = new Worker(url);\n\n    setTimeout(() => {\n      try {\n        URL.revokeObjectURL(url);\n      } catch (_) {}\n    }, 1000);\n\n    logger.info('[ProLeasePlugin] Calculation worker created');\n    return worker;\n  }\n\n  // ========================================================================\n  // UTILITY METHODS\n  // ========================================================================\n\n  private refreshControlPanel(): void {\n    const panel = document.querySelector('#plugin-panel-prolease-manager .panel-content');\n    if (panel) {\n      this.renderControlPanel(panel as HTMLElement);\n    }\n  }\n\n  private promptNumber(message: string, defaultValue: number): number | null {\n    const input = prompt(message, String(defaultValue));\n    if (input === null) return null;\n    const num = parseFloat(input);\n    return isNaN(num) ? null : num;\n  }\n\n  private generateId(): string {\n    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  private formatCurrency(value: number): string {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(value);\n  }\n}\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport const manifest = new ProLeasePlugin().manifest;\nexport default ProLeasePlugin;\n","/**\n * ProLease Plugin Entry Point for Standalone Build\n *\n * This file serves as the entry point when building the plugin as a standalone module\n */\n\nimport { ProLeasePlugin, manifest } from './prolease-ifrs16-plugin';\n\n// Export everything needed for the plugin\nexport { ProLeasePlugin, manifest };\n\n// Default export for convenience\nexport default {\n  ProLeasePlugin,\n  manifest,\n  version: '6.0.0',\n  name: 'ProLease IFRS 16',\n};\n"],"names":["ProLeasePlugin","constructor","__publicField","this","id","name","version","author","description","permissions","entryPoint","init","context","logger","info","loadContracts","worker","createCalculationWorker","registerFormulas","setupUI","contracts","length","ui","showToast","error","dispose","terminate","saveContracts","saved","storage","get","set","registry","kernel","calcEngine","getRegistry","register","monthlyRate","months","payment","Math","pow","argCount","annualRate","leaseLiability","directCosts","allowance","addToolbarButton","label","icon","tooltip","onClick","handleNewContract","addPanel","title","position","render","container","renderControlPanel","innerHTML","renderContractsList","createBtn","querySelector","addEventListener","attachContractListeners","map","c","escapeHtml","contractName","Date","startDate","toLocaleDateString","termMonths","formatCurrency","totalRent","join","querySelectorAll","forEach","btn","e","contractId","target","getAttribute","contract","find","handleRecalculate","handleDelete","item","style","background","prompt","some","promptNumber","toISOString","split","serviceDeductions","discountRate","initialLandlordAllowance","initialDirectCosts","generateId","createdAt","updatedAt","push","calculateAndCreateSheet","refreshControlPanel","confirm","filter","postMessage","action","payload","onmessage","event","data","populateSheet","calculatedRows","wbManager","workbookManager","wb","getActiveWorkbook","createWorkbook","setActiveWorkbook","sheetName","sheet","Array","from","sheets","values","s","rows","rowMap","rowIdx","_cell","colIdx","clearCell","addSheet","Error","headers","dataRows","slice","header","col","setCell","String","type","format","bold","alignment","row","val","cellType","setActiveSheet","recalculate","force","cols","blob","Blob","url","URL","createObjectURL","Worker","setTimeout","revokeObjectURL","_","panel","document","message","defaultValue","input","num","parseFloat","isNaN","now","random","toString","substr","text","div","createElement","textContent","value","Intl","NumberFormat","currency","minimumFractionDigits","maximumFractionDigits","manifest","index"],"mappings":"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"}